[LONG CODE OMITTED HERE FOR BREVITY - included in previous message]